{% extends 'admin_area/base.html' %}
{% block define %}
    <script>
        $('#page_title').text('{{ item_p.item_name }}');
        {% if success %}
            $(document).ready(function(){
                alert("操作成功")
                window.location.href = "program_manage_two?item_p_id={{ item_p.id }}"
            });
        {% endif %}
    </script>
<div class="col-lg-12 col-md-12 panel panel-default" style="margin-top: 5%;padding-left: 7%">
 <div class="panel-body">
       <div class="col-lg-4 col-md-4 text-right">
            <h6>项目名称:</h6>
            <h6 style="margin-top: 9%">排序id:</h6>
            <h6 style="margin-top: 9%">图片:</h6>
        </div>
       <div class="col-lg-6 col-md-6" style="padding-top: 0.5%;padding-left: 0">
       <form action="edit_program_detail" method="post" id="p_mes" enctype="multipart/form-data">
          {% csrf_token %}
            <input type="text" name="item_p_id" value="{{ item_p.id }}" style="display: none"/>
            <input type="text" name="item_id" value="{{ item.id }}" style="display: none">
            <input type="text" class="form-control" id="item_name" name='item_name'
                   placeholder="请输入项目名称" style="width: 300px;margin-top: 0.5%" value="{{ item.item_name }}"/>
            <span id="sort_id_have" style="position: absolute;z-index: 99;margin-left: 45%;margin-top: 25px;font-size:14px;color: red"></span>
            <input type="text" class="form-control" id="sort_id" name='sort_id'
                   placeholder="请输入排序id" style="width: 300px;margin-top: 2.5%" value="{{ item.sort_id }}"
                    onkeyup="this.value=this.value.replace(/\D/g,'')"/>
             <input type="file" name="home_item_pic" id="file0" multiple="multiple" style="margin-top:5%;"/><br/>
            <p>请上传PNG图片</p>
              {% if item_p %}
                {% if item.pic_url %}
                   <img style="width: 400px;" src="{{ item.pic_url }}" id="img0" >
                {% else %}
                   <img style="width: 400px;" src="" id="img0" >
                {% endif %}
              {% else %}
                 <img style="width: 400px;" src="" id="img0" >
              {% endif %}
            <p style="color: red" id="warning"></p>
       </form>
       </div>
    <div class="col-lg-12 col-md-12" style="margin-top: 2%">
        <button id="submit" class="btn btn-success btn-lg" style="margin-left: 36%">提交</button>
        <a href="program_manage_two?item_p_id={{ item_p.id }}" role="button" class="btn btn-default btn-lg" style="margin-left: 5%">取消</a>
    </div>
    <script>
        $('#file0').change(function(){
            var file0 = this.files[0];
	        var objUrl = getObjectURL(file0);
	        console.log("objUrl = "+objUrl) ;
	        if (objUrl) {
		        $("#img0").attr("src", objUrl);
                $('#img0').load(function(){
                    var image = new Image();
                    image.src = $('#img0').attr('src');
                    if(!/(png|PNG)$/.test(file0.type)){
                        $('#submit').addClass('disabled');
                        $('#warning').text('图像格式不正确，请上传PNG图片');
                        return false
                    }
                    $('#submit').removeClass('disabled');
                    $('#warning').text('');
                    return true
                })
	        }
        });
    </script>
    <script>
        $('#submit').click(function(){
            if($('#item_name').val() && $('#img0').attr('src') && $('#sort_id').val()){
                $('#p_mes').submit();
            }
            else{
                alert("请完善信息！！")
            }
        });
        {% if not item %}
            $('#sort_id').keyup(function(){
                if(!$('#sort_id')){
                    return false
                }
                $.ajax({
                    type: 'GET',
                    url: 'check_home_item_sort_id',
                    data: {'sort_id': $('#sort_id').val(),
                           'item_p_id': '{{ item_p.id }}',
                           'item_id': '{{ item.id }}'},
                    success: function(data){
                        if(data == 'F'){
                            $('#sort_id_have').text("排序ID已存在");
                            $('#submit').addClass('disabled');
                        }
                        else {
                            $('#sort_id_have').text('');
                            $('#submit').removeClass('disabled');
                        }
                    },
                    dataType: 'json'
                })
            });
        {% endif %}
    </script>
 </div>
</div>
{% endblock %}
